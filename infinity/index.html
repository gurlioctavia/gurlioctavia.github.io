<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Infinity Letter</title>
  <style>
    body{font:16px system-ui;margin:24px;max-width:900px}
    h1{margin:0 0 14px 0}
    .hint{font-size:56px;letter-spacing:-0.02em;line-height:1.02;margin:0 0 14px 0}
    textarea{width:100%;min-height:92px;padding:12px;font:16px system-ui}
    button{font:inherit;padding:10px 14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
    .meta{opacity:.7}
    .err{opacity:1}
    .hidden{display:none}
    .letter{white-space:pre-wrap;margin-top:18px;padding-top:14px;border-top:1px solid #eee}
  </style>
</head>
<body>
  <h1>Infinity Letter</h1>

  <div class="hint" id="hint">…</div>

  <div id="writeUI">
    <textarea id="sentence" placeholder=""></textarea>
    <div class="row">
      <button id="send">Send</button>
      <span class="meta" id="msg"></span>
    </div>
  </div>

  <div id="afterUI" class="hidden">
    <div class="letter" id="fullLetter"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://zfjifobxbvjbnzntzhfq.supabase.co";
    const SUPABASE_KEY = "sb_publishable_q77ViXgTiWvPhQFT14Ap8g_yKV4Joyu";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const sidKey = "infinity_session_id";
    const sessionId = localStorage.getItem(sidKey) || crypto.randomUUID();
    localStorage.setItem(sidKey, sessionId);

    const $hint = document.getElementById("hint");
    const $msg = document.getElementById("msg");
    const $writeUI = document.getElementById("writeUI");
    const $afterUI = document.getElementById("afterUI");
    const $fullLetter = document.getElementById("fullLetter");

    function setMsg(t, isErr=false){
      $msg.textContent = t || "";
      $msg.className = isErr ? "meta err" : "meta";
    }

    async function loadHint(){
      const { data, error } = await sb.rpc("infinity_public_state");
      if (error) return setMsg(error.message, true);
      const s = data?.[0];
      if (!s) return setMsg("Missing state", true);

      $hint.textContent = s.current_hint || "…";

      // If user already wrote (or letter is closed), show full letter
      const { data: fullData } = await sb.rpc("infinity_full_for_session", { p_session_id: sessionId });
      const full = fullData?.[0];
      if (full) {
        $fullLetter.textContent = ((full.seed_text || "") + " " + (full.full_text || "")).trim();
        $afterUI.classList.remove("hidden");
        $writeUI.classList.add("hidden");
      }
    }

    async function send(){
      const sentence = document.getElementById("sentence").value.trim();
      if (!sentence) return;

      setMsg("Sending…");
      const { error } = await sb.rpc("infinity_submit", { p_session_id: sessionId, p_sentence: sentence });
      if (error) return setMsg(error.message, true);

      document.getElementById("sentence").value = "";
      setMsg("");

      // After submit: show full letter + hide input
      const { data } = await sb.rpc("infinity_full_for_session", { p_session_id: sessionId });
      const full = data?.[0];
      if (full) {
        $fullLetter.textContent = ((full.seed_text || "") + " " + (full.full_text || "")).trim();
        $afterUI.classList.remove("hidden");
        $writeUI.classList.add("hidden");
      }

      // Update hint for next visitor
      await loadHint();
    }

    document.getElementById("send").addEventListener("click", send);

    loadHint();
    setInterval(loadHint, 2500);
  </script>
</body>
</html>
